generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Lookup Tables
model ChucVu {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  VienChuc VienChuc[]
}

model LoaiDonVi {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  DonVi DonVi[]
}

model QuocGia {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  ma_iso String @unique
  HoSo HoSo[]
}

model HinhThucDi {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  HoSo HoSo[]
}

model NguonKinhPhi {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  HoSo HoSo[]
}

model LoaiHoSo {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  HoSo HoSo[]
}

model TrangThai {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  HoSo HoSo[]
  LichSuTrangThai LichSuTrangThai[]
}

model BuocXuLy {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  thu_tu Int
  LichSuTrangThai LichSuTrangThai[]
}

model VaiTroDangVien {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  VienChucDangVien VienChucDangVien[]
}

// Core Tables
model DonVi {
  id    Int    @id @default(autoincrement())
  ma    String @unique
  ten   String
  loai_don_vi_id Int
  parent_id Int?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  created_by Int
  LoaiDonVi LoaiDonVi @relation(fields: [loai_don_vi_id], references: [id])
  parent   DonVi? @relation("DonViParent", fields: [parent_id], references: [id])
  children DonVi[] @relation("DonViParent")
  ChiBo ChiBo[]
  DangUy DangUy[]
  VienChuc VienChuc[]
  Users Users[]
}

model ChiBo {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  don_vi_id Int
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  DonVi DonVi @relation(fields: [don_vi_id], references: [id])
  VienChucDangVien VienChucDangVien[]
}

model DangUy {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  don_vi_id Int
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  DonVi DonVi @relation(fields: [don_vi_id], references: [id])
  VienChucDangVien VienChucDangVien[]
}

model VienChuc {
  id    Int    @id @default(autoincrement())
  ma_vien_chuc String @unique
  ho_ten String
  don_vi_id Int
  chuc_vu_id Int
  is_dang_vien Boolean @default(false)
  gioi_tinh String?
  ngay_sinh DateTime?
  so_cmnd_ho_chieu String?
  email String?
  dien_thoai String?
  dia_chi_thuong_tru String?
  dia_chi_lien_lac String?
  ngay_vao_truong DateTime?
  avatar String?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  created_by Int
  DonVi DonVi @relation(fields: [don_vi_id], references: [id])
  ChucVu ChucVu @relation(fields: [chuc_vu_id], references: [id])
  HoSo HoSo[]
  Users Users[]
  VienChucDangVien VienChucDangVien[]
}

model UserRole {
  id    Int    @id @default(autoincrement())
  ten   String @unique
  mo_ta String?
  Users Users[]
  YKien YKien[]
}

model Users {
  id    Int    @id @default(autoincrement())
  email String @unique
  mat_khau_hash String?
  must_change_password Boolean @default(true)
  vien_chuc_id Int?
  don_vi_id Int?
  vai_tro_id Int
  is_active Boolean @default(true)
  is_email_verified Boolean @default(false)
  last_login_at DateTime?
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  created_by Int
  VienChuc VienChuc? @relation(fields: [vien_chuc_id], references: [id])
  DonVi DonVi? @relation(fields: [don_vi_id], references: [id])
  UserRole UserRole @relation(fields: [vai_tro_id], references: [id])
  YKien YKien[]
  ThongBao ThongBao[]
  QuyetDinh QuyetDinh[] @relation("BanHanhQuyetDinh")
  AuditLog AuditLog[]
}

model HoSo {
  id    Int    @id @default(autoincrement())
  ma_ho_so String @unique
  vien_chuc_id Int
  loai_ho_so_id Int
  quoc_gia_id Int
  hinh_thuc_di_id Int
  nguon_kinh_phi_id Int
  noi_dung String
  ngay_di DateTime
  ngay_ve DateTime
  trang_thai_id Int
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  created_by Int
  VienChuc VienChuc @relation(fields: [vien_chuc_id], references: [id])
  LoaiHoSo LoaiHoSo @relation(fields: [loai_ho_so_id], references: [id])
  QuocGia QuocGia @relation(fields: [quoc_gia_id], references: [id])
  HinhThucDi HinhThucDi @relation(fields: [hinh_thuc_di_id], references: [id])
  NguonKinhPhi NguonKinhPhi @relation(fields: [nguon_kinh_phi_id], references: [id])
  TrangThai TrangThai @relation(fields: [trang_thai_id], references: [id])
  FileTaiLieu FileTaiLieu[]
  NguoiDiCung NguoiDiCung[]
  LichSuTrangThai LichSuTrangThai[]
  YKien YKien[]
  QuyetDinh QuyetDinh[]
}

model FileTaiLieu {
  id    Int    @id @default(autoincrement())
  ho_so_id Int
  ten_file String
  duong_dan String
  file_hash String?
  mo_ta String?
  uploaded_at DateTime @default(now())
  uploaded_by Int
  HoSo HoSo @relation(fields: [ho_so_id], references: [id], onDelete: Cascade)
}

model NguoiDiCung {
  id    Int    @id @default(autoincrement())
  ho_so_id Int
  ho_ten String
  quan_he String?
  ghi_chu String?
  HoSo HoSo @relation(fields: [ho_so_id], references: [id], onDelete: Cascade)
}

model LichSuTrangThai {
  id    Int    @id @default(autoincrement())
  ho_so_id Int
  trang_thai_id Int
  buoc_xu_ly_id Int
  ghi_chu String?
  changed_at DateTime @default(now())
  changed_by Int
  HoSo HoSo @relation(fields: [ho_so_id], references: [id], onDelete: Cascade)
  TrangThai TrangThai @relation(fields: [trang_thai_id], references: [id])
  BuocXuLy BuocXuLy @relation(fields: [buoc_xu_ly_id], references: [id])
}

model YKien {
  id    Int    @id @default(autoincrement())
  ho_so_id Int
  nguoi_dung_id Int
  vai_tro_id Int
  noi_dung String
  created_at DateTime @default(now())
  HoSo HoSo @relation(fields: [ho_so_id], references: [id], onDelete: Cascade)
  Users Users @relation(fields: [nguoi_dung_id], references: [id])
  UserRole UserRole @relation(fields: [vai_tro_id], references: [id])
}

model ThongBao {
  id    Int    @id @default(autoincrement())
  nguoi_dung_id Int
  noi_dung String
  loai_thong_bao String?
  is_read Boolean @default(false)
  created_at DateTime @default(now())
  Users Users @relation(fields: [nguoi_dung_id], references: [id])
}

model QuyetDinh {
  id    Int    @id @default(autoincrement())
  ho_so_id Int
  so_quyet_dinh String @unique
  noi_dung String
  ngay_ban_hanh DateTime
  ban_hanh_boi Int
  created_at DateTime @default(now())
  HoSo HoSo @relation(fields: [ho_so_id], references: [id], onDelete: Cascade)
  Users Users @relation("BanHanhQuyetDinh", fields: [ban_hanh_boi], references: [id])
}

model VienChucDangVien {
  id    Int    @id @default(autoincrement())
  vien_chuc_id Int
  chi_bo_id Int?
  dang_uy_id Int?
  vai_tro_dang_vien_id Int
  ngay_nhan_vai_tro DateTime?
  ngay_ket_thuc_vai_tro DateTime?
  ghi_chu String?
  VienChuc VienChuc @relation(fields: [vien_chuc_id], references: [id])
  ChiBo ChiBo? @relation(fields: [chi_bo_id], references: [id])
  DangUy DangUy? @relation(fields: [dang_uy_id], references: [id])
  VaiTroDangVien VaiTroDangVien @relation(fields: [vai_tro_dang_vien_id], references: [id])
}

model AuditLog {
  id    Int    @id @default(autoincrement())
  table_name String
  record_id Int
  action_type String
  changed_by Int
  changed_at DateTime @default(now())
  old_data Json?
  new_data Json?
  Users Users @relation(fields: [changed_by], references: [id])
}
